#!/bin/bash

cp DEINFO_AB_FEIRASLIVRES_2014.csv DEINFO_AB_FEIRASLIVRES_2014_tmp.csv
DATABASE_TMP=DEINFO_AB_FEIRASLIVRES_2014_tmp.csv
DATABASE_SQL=streetmarket.sql

[[ -f "${DATABASE_SQL}" ]] && {
  rm "${DATABASE_SQL}"
}

sed -i 's/\r$//' "${DATABASE_TMP}"

while IFS="," read -r ID LONG LAT SETCENS AREAP CODDIST DISTRITO CODSUBPREF SUBPREFE REGIAO5 REGIAO8 NOME_FEIRA REGISTRO LOGRADOURO NUMERO BAIRRO REFERENCIA; do
    echo "INSERT INTO MARKET.STREET_MARKET (BOROUGH, BOROUGH_CODE, DISTRICT, DISTRICT_CODE, LANDMARK, LAT, LONG, NAME, NEIGHBORHOOD, NUMBER, REGION5, REGION8, REGISTER, SECTOR, STREET, WEIGHTING_AREA, ID) VALUES ('$(sed "s/'/''/g" <<< $SUBPREFE)', $CODSUBPREF, '$DISTRITO', $CODDIST, '$(sed "s/'/''/g" <<< $REFERENCIA)', $LAT, $LONG, '$(sed "s/'/''/g" <<< $NOME_FEIRA)', '$BAIRRO', '$NUMERO', '$REGIAO5', '$REGIAO8', '$REGISTRO', $SETCENS, '$(sed "s/'/''/g" <<< $LOGRADOURO)', $AREAP, nextval('MARKET.SQ_STREET_MARKET'));" >> $DATABASE_SQL
done < "${DATABASE_TMP}"

rm "${DATABASE_TMP}"

docker exec -i database-market psql -U market -d market < $DATABASE_SQL > /dev/null 2>&1 || true
